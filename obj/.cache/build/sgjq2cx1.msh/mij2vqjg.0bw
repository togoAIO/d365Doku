<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Configuration for Finance Insights (preview) | WIKA Documentation </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Configuration for Finance Insights (preview) | WIKA Documentation ">
    <meta name="generator" content="docfx 2.56.6.0">
    
    <link rel="shortcut icon" href="../../../microsoft-dynamics-crm-365-icon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
    <meta property="docfx:navrel" content="../../../toc.html">
    <meta property="docfx:tocrel" content="../TOC.html">
    
    
    
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="configuration-for-finance-insights-preview" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="31">Configuration for Finance insights (preview)</h1>

<div class="IMPORTANT" sourcefile="articles/finance/includes/preview-banner.md" sourcestartlinenumber="1">
<h5>Important</h5>
<p sourcefile="articles/finance/includes/preview-banner.md" sourcestartlinenumber="2">Some or all of the functionality noted in this topic is available as part of a preview release. The content and the functionality are subject to change. For more information about preview releases, see <a href="https://docs.microsoft.com/dynamics365/unified-operations/fin-and-ops/get-started/public-preview-releases" sourcefile="articles/finance/includes/preview-banner.md" sourcestartlinenumber="2">Service update availability</a>.</p>
</div>
[!include[rename-banner](~/includes/cc-data-platform-banner.md)]
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="39">Finance insights combines functionality from Microsoft Dynamics 365 Finance with Microsoft Dataverse, Azure, and AI Builder to provide powerful forecasting tools for your organization. This topic explains the configuration steps that will enable your system to use the capabilities that are available in Finance insights.</p>
<h2 id="deploy-dynamics-365-finance" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="41">Deploy Dynamics 365 Finance</h2>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="43">Deploy the environments by following these steps.</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="45">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="45">In Microsoft Dynamics Lifecycle Services (LCS), create or update a Dynamics 365 Finance environment. The environment requires app version 10.0.11/Platform update 35 or later.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="46">The environment must be a high-availability (HA) environment in Sandbox. (This type of environment is also known as a Tier-2 environment.) For more information, see <a href="https://docs.wika.com/en-us/dynamics365/supply-chain/fin-ops-core/fin-ops/imp-lifecycle/environment-planning" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="46">Environment planning (This is an external linThis link was changed due to HTMLfromRepoGenerator)</a>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="47">If you're using Contoso demo data, you will require additional sample data to use the Customer payment predictions, Cash flow forecasts, and Budget forecasts features.</li>
</ol>
<h2 id="configure-dataverse" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="49">Configure Dataverse</h2>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="51">You can complete the manual configuration steps that follow, or you can speed up the configuration process by using the Windows PowerShell script that is provided. When the PowerShell script has finished running, it will give you values to use to configure Finance insights.</p>
<div class="NOTE" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="53">
<h5>Note</h5>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="54">Open PowerShell on your PC to run the script. You may need PowerShell version 5. The Microsoft Azure CLI &quot;Try it&quot; option may not work.</p>
</div>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="56">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_configuration-steps" role="tab" aria-controls="tabpanel_CeZOj-G++Q_configuration-steps" data-tab="configuration-steps" tabindex="0" aria-selected="true" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="56">Manual configuration steps</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q_powershell-configuration-script" role="tab" aria-controls="tabpanel_CeZOj-G++Q_powershell-configuration-script" data-tab="powershell-configuration-script" tabindex="-1" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="89">Windows PowerShell configuration script</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q_configuration-steps" role="tabpanel" data-tab="configuration-steps">

<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="58">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="58"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="58">Open the <a href="https://admin.powerplatform.microsoft.com/" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="58">Power Platform admin center</a>, and follow these steps to create a new Dataverse environment in the same Active Directory tenant:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="60">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="60"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="60">Open the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="60">Environments</strong> page.</p>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="62"><a href="./media/power-pltfrm-admin-center.png" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="62"><img src="./media/power-pltfrm-admin-center.png" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="62" alt="Environments page"></a></p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="64"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="64">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="64">New environment</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="65"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="65">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="65">Type</strong> field, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="65">Sandbox</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="66"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="66">Set the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="66">Create Database</strong> option to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="66">Yes</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="67"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="67">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="67">Next</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="68"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="68">Select the language and currency for your organization.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="69"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="69">Accept the default values for the other fields.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="70"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="70">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="70">Save</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="71"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="71">Refresh the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="71">Environments</strong> page.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="72"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="72">Wait until the value of the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="72">State</strong> field is updated to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="72">Ready</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="73"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="73">Make a note of the Dataverse organization ID.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="74"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="74">Select the environment, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="74">Settings</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="75"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="75">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="75">Resources &gt; All Legacy Settings</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="76"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="76">On the top navigation bar, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="76">Settings</strong>, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="76">Customizations</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="77"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="77">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="77">Developer Resources</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="78"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="78">Set the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="78">Instance Reference Information ID</strong> field to the Dataverse organization ID value that you made a note of earlier.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="79"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="79">In the browser's address bar, make a note of the URL for the Dataverse organization. For example, the URL might be <code sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="79">https://org42b2b3d3.crm.dynamics.com</code>.</p>
</li>
</ol>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="81"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="81">If you plan to use the Cash flow forecasts or Budget forecasts feature, follow these steps to update the annotation limit for your organization to at least 50 megabytes (MB):</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="83">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="83">Open the <a href="https://make.powerapps.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="83">Power Apps portal</a>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="84">Select the environment that you just created, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="84">Advanced settings</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="85">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="85">Settings &gt; Email Configuration</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="86">Change the value of the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="86">Maximum file size</strong> field to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="86">51,200</strong>. (The value is expressed in kilobytes [KB].)</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="87">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="87">OK</strong> to save your changes.</li>
</ol>
</li>
</ol>
</section>
<section id="tabpanel_CeZOj-G++Q_powershell-configuration-script" role="tabpanel" data-tab="powershell-configuration-script" aria-hidden="true" hidden="hidden">

<pre><code class="lang-azurecli" data-interactive="azurecli" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="91">Write-Output 'The following modules need to be present for execution of this script:'
Write-Output '  Microsoft.PowerApps.Administration.PowerShell'
Write-Output '  Microsoft.PowerApps.PowerShell'
Write-Output '  Microsoft.Xrm.Tooling.CrmConnector.PowerShell'

try {
    $moduleConsent = Read-Host 'Is it ok to install or update these modules as needed? (yes/no)'
    if ($moduleConsent -ne 'yes' -and $moduleConsent -ne 'y') {
        Write-Warning 'User declined to install required modules.'
        return
    }

    $module = 'Microsoft.PowerApps.Administration.PowerShell'
    if (-not (Get-InstalledModule -Name $module -MinimumVersion '2.0.61' -ErrorAction SilentlyContinue)) {
        Install-Module -Name $module -MinimumVersion '2.0.61' -Force
        Write-Output ('Installed {0} module.' -f $module)
    }
    else {
        Write-Output ('{0} module found.' -f $module)
    }

    $module = 'Microsoft.PowerApps.PowerShell'
    if (-not (Get-InstalledModule -Name $module -MinimumVersion '1.0.9' -ErrorAction SilentlyContinue)) {
        Install-Module -Name $module -MinimumVersion '1.0.9' -AllowClobber -Force
        Write-Output ('Installed {0} module.' -f $module)
    }
    else {
        Write-Output ('{0} module found.' -f $module)
    }

    $module = 'Microsoft.Xrm.Tooling.CrmConnector.PowerShell'
    if (-not (Get-InstalledModule -Name $module -MinimumVersion '3.3.0.892' -ErrorAction SilentlyContinue)) {
        Install-Module -Name $module -MinimumVersion '3.3.0.892' -Force
        Write-Output ('Installed {0} module.' -f $module)
    }
    else {
        Write-Output ('{0} module found.' -f $module)
    }

    Write-Output '================================================================================='

    $useMfa = $false
    $useMfaPrompt = Read-Host &quot;Does your organization require the use of multi-factor authentication? (yes/no)&quot;
    if ($useMfaPrompt -eq 'yes' -or $useMfaPrompt -eq 'y') {
        $useMfa = $true
    }
    if(-not $useMfa) {
        $credential = Get-Credential -Message 'Power Apps Credential'
    }

    $orgFriendlyName = Read-Host &quot;Enter the name of the CDS Organization to use or create: (blank for 'FinanceInsightsOrg')&quot;
    if ($orgFriendlyName.Trim() -eq '') {
        $orgFriendlyName = 'FinanceInsightsOrg'
    }

    $isDefaultOrgPrompt = Read-Host (&quot;Is '&quot; + $orgFriendlyName + &quot;' the default organization for your tenant? (yes/no)&quot;)
    if ($isDefaultOrgPrompt -eq 'yes' -or $isDefaultOrgPrompt -eq 'y') {
        $isDefaultOrg = $true
    }

    if ($credential) {
        Add-PowerAppsAccount -Username $credential.UserName -Password $credential.Password
    }
    else {
        Add-PowerAppsAccount
    }

    if ($isDefaultOrg) {
        $orgMatch = ('(default)')
        $environment = (Get-AdminPowerAppEnvironment | Where-Object { $_.IsDefault -eq $true })
    }
    else {
        $orgMatch = ('{0} (*)' -f $orgFriendlyName)
        $environment = (Get-AdminPowerAppEnvironment | Where-Object { ($_.IsDefault -eq $false -and ($_.DisplayName -eq $orgFriendlyName -or $_.DisplayName -like $orgMatch)) })
    }

    $getCrmOrgParams = @{ 'OnlineType' = 'Office365' }
    if ($credential) {
        $getCrmOrgParams.Credential = $credential
    }

    if ($null -eq $environment) {
        Write-Output '================================================================================='
        Write-Output 'PowerApps environment not found. A new one will be provisioned.'

        $invalid = 'invalid'

        $location = $invalid
        $cdsLocations = (Get-AdminPowerAppEnvironmentLocations | Select-Object LocationName).LocationName
        while (-not ($location -in $cdsLocations)) {
            $location = (Read-Host -Prompt &quot;Enter the location in which to create the new PowerApps environment: ('help' to see values)&quot;)
            if ($location -eq 'help') {
                $cdsLocations
            }
        }

        $currency = $invalid
        $cdsCurrencies = (Get-AdminPowerAppCdsDatabaseCurrencies -Location $location | Select-Object CurrencyName).CurrencyName
        while ($currency -ne '' -and -not ($currency -in $cdsCurrencies)) {
            $currency = (Read-Host -Prompt &quot;Enter the currency to use for the new PowerApps environment: ('help' to see values, blank for default)&quot;)
            if ($currency -eq 'help') {
                $cdsCurrencies
            }
        }

        $language = $invalid
        $cdsLanguages = (Get-AdminPowerAppCdsDatabaseLanguages -Location $location | Select-Object LanguageName, LanguageDisplayName)
        while ($language -ne '' -and -not ($language -in $cdsLanguages.LanguageName)) {
            $language = (Read-Host -Prompt &quot;Enter the language name to use for the new PowerApps environment: ('help' to see values, blank for default)&quot;)
            if ($language -eq 'help') {
                $cdsLanguages | Format-Table -Property LanguageName, LanguageDisplayName
            }
        }

        Write-Output 'Provisioning PowerApps environment. This may take several minutes.'

        $sleep = 15

        $envParams = @{ 'DisplayName' = $orgFriendlyName; 'EnvironmentSku' = 'Sandbox'; 'ProvisionDatabase' = $true; 'Location' = $location; 'WaitUntilFinished' = $true }
        if ($language.Trim() -ne '') {
            $envParams.LanguageName = $language
        }
        if ($currency.Trim() -ne '') {
            $envParams.CurrencyName = $currency
        }
        $newEnvResult = New-AdminPowerAppEnvironment @envParams
        if (($null -eq $newEnvResult) -or ($newEnvResult.CommonDataServiceDatabaseProvisioningState -ne 'Succeeded')) {
            Write-Warning 'Failed to create to PowerApps environment'
            if ($null -ne $newEnvResult) {
                $newEnvResult
            }
        }
        else {
            $environment = $null
            $retryCount = 0
            while (($null -eq $environment) -and ($retryCount -lt 5)) {
                Start-Sleep -Seconds $sleep
                $environment = (Get-AdminPowerAppEnvironment | Where-Object { ($_.DisplayName -like $orgMatch) })
            }
            Write-Output (&quot;Provisioned PowerApps environment with name: '&quot; + $environment.DisplayName + &quot;'&quot;)
        }

        Write-Output 'Waiting for CDS organization provisioning. This may take several minutes.'
        if (-not $credential) {
            $sleep = 120
            Write-Output 'You may be prompted for credentials multiple times while checking the status of the provisioning.'
        }

        while ($null -eq $crmOrg) {
            Start-Sleep -Seconds $sleep
            $crmOrg = (Get-CrmOrganizations @getCrmOrgParams) | Where-Object { $_.FriendlyName -eq $orgFriendlyName }
        }
    }
    else {
        $crmOrgs = Get-CrmOrganizations @getCrmOrgParams
        if ($UseDefaultOrganization -eq $true) {
            $crmOrg = $crmOrgs | Where-Object { $_.FriendlyName -match $orgMatch }
        }
        else {
            $crmOrg = $crmOrgs | Where-Object { $_.FriendlyName -eq $orgFriendlyName }
        }
    }

    Write-Output '================================================================================='
    Write-Output 'Values for PowerAI LCS Add-In:'
    Write-Output (&quot;  CDS organization url:             &quot; + $crmOrg.WebApplicationUrl)
    Write-Output (&quot;  CDS organization ID:              &quot; + $crmOrg.OrganizationId)
}
catch {
    Write-Error $_.Exception.Message
    Write-Warning $_.Exception.StackTrace
    $inner = $_.Exception.InnerException
    while ($null -ne $inner) {
        Write-Output 'Inner Exception:'
        Write-Error $_.Exception.Message
        Write-Warning $_.Exception.StackTrace
        $inner = $inner.InnerException
    }
}
</code></pre>
</section>
</div>
<h2 id="configure-the-azure-setup" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="274">Configure the Azure setup</h2>
<h3 id="enter-the-dataverse-directory-id-and-the-users-azure-ad-object-id" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="276">Enter the Dataverse directory ID and the user's Azure AD object ID</h3>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="278">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="278"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="278">Enter the Dataverse directory ID:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="280">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="280">Open the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="280">Azure portal</a>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="281">Sign in by using the user ID that was used to create the Dataverse environment.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="282">Go to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="282">Azure Active Directory</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="283">Copy the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="283">Tenant ID</strong> value.</li>
</ol>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="285"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="285">Enter the user's Azure Active Directory (Azure AD) object ID:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="287">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="287">In the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="287">Azure portal</a>, go to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="287">Users</strong>, and search for the user by email address.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="288">Select the user's name.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="289">Copy the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="289">Object ID</strong> value.</li>
</ol>
</li>
</ol>
<h3 id="use-azure-cloud-shell-to-set-up-finance-insights-data-lake-resources" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="291">Use Azure Cloud Shell to set up Finance insights Data Lake resources</h3>
<div class="tabGroup" id="tabgroup_CeZOj-G++Q-1" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="293">
<ul role="tablist">
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_use-a-powershell-script" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_use-a-powershell-script" data-tab="use-a-powershell-script" tabindex="0" aria-selected="true" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="293">Use a Windows PowerShell script</a>
</li>
<li role="presentation">
<a href="#tabpanel_CeZOj-G++Q-1_azure-azure-cli" role="tab" aria-controls="tabpanel_CeZOj-G++Q-1_azure-azure-cli" data-tab="azure-azure-cli" tabindex="-1" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="452">Azure CLI</a>
</li>
</ul>
<section id="tabpanel_CeZOj-G++Q-1_use-a-powershell-script" role="tabpanel" data-tab="use-a-powershell-script">

<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="295">A Windows PowerShell script has been provided, so that you can easily set up the Azure resources that are described in <a href="https://docs.microsoft.com/dynamics365/fin-ops-core/dev-itpro/data-entities/configure-export-data-lake" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="295">Configure export to Azure Data Lake</a>. If you prefer to do manual setup, skip this procedure, and continue with the procedure in the <a href="#manual-setup" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="295">Manual setup</a> section.</p>
<div class="NOTE" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="297">
<h5>Note</h5>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="298">Follow the steps below to run the PowerShell script. The Azure CLI &quot;Try it&quot; option, or running the script on your PC may not work.</p>
</div>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="300">Follow these steps to configure Azure by using the Windows PowerShell script. You must have rights to create an Azure resource group, Azure resources, and an Azure AD application. For information about the required permissions, see <a href="https://docs.microsoft.com/azure/active-directory/develop/howto-create-service-principal-portal#permissions-required-for-registering-an-app" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="300">Check Azure AD permissions</a>.</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="302">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="302">In the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="302">Azure portal</a>, go to your target Azure subscription. Select the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="302">Cloud Shell</strong> button to the right of the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="302">Search</strong> field.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="303">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="303">PowerShell</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="304">Create storage, if you're prompted to do so. Then upload the Windows PowerShell script to the session.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="305">Run the script.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="306">Follow the prompts to run the script.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="307">Use the information from the script output to install the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="307">Export to Data Lake</strong> add-in in LCS.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="308">Use the information from the script output to enable the entity store on the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="308">Data connections</strong> page in Finance (<strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="308">System administration &gt; System parameters &gt; Data connections</strong>).</li>
</ol>
<h3 id="manual-setup" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="310">Manual setup</h3>
<h4 id="add-applications-to-the-azure-ad-tenant" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="312">Add applications to the Azure AD tenant</h4>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="314">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="314"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="314">In the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="314">Azure portal</a>, go to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="314">Azure Active Directory</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="315"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="315">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="315">Manage &gt; Enterprise applications</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="316"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="316">Search for the following applications by app ID.</p>
<table sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="318">
<thead>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="318">
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="318">Application</th>
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="318">App ID</th>
</tr>
</thead>
<tbody>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="320">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="320">Microsoft Dynamics ERP Microservices</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="320">0cdb527f-a8d1-4bf8-9436-b352c68682b2</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="321">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="321">Microsoft Dynamics ERP Microservices CDS</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="321">703e2651-d3fc-48f5-942c-74274233dba8</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="322">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="322">AI Builder Authorization Service</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="322">ad40333e-9910-4b61-b281-e3aeeb8c3ef3</td>
</tr>
</tbody>
</table>
</li>
</ol>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="324">If you can't find any of the preceding applications, try the following steps.</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="326">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="326"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="326">On your local machine, select the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="326">Start</strong> menu, and search for <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="326">powershell</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="327"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="327">Select and hold (or right-click) <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="327">Windows PowerShell</strong>, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="327">Run as administrator</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="328"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="328">Run the following command to install the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="328">AzureAD</strong> module.</p>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="330"><code sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="330">Install-Module -Name AzureAD</code></p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="332"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="332">If a NuGet provider is required to continue, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="332">Y</strong> to install it.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="333"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="333">If an &quot;Untrusted repository&quot; message appears, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="333">Y</strong> to continue.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="334"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="334">For each application that must be added, run the following commands to add the application to Azure AD. When you're prompted, sign in as the Azure AD administrator.</p>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="336"><code sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="336">Connect-AzureAD</code></p>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="338"><code sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="338">New-AzureADServicePrincipal –AppId &lt;AppId&gt;</code></p>
</li>
</ol>
<h4 id="create-azure-resources" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="340">Create Azure resources</h4>
<div class="NOTE" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="342">
<h5>Note</h5>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="343">Make sure that you create the following resources in the same Azure AD instance as the Dataverse environment. You can't use resources from a different Azure AD instance.</p>
</div>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="345">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="345"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="345">Create a new storage account:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="347">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="347"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="347">In the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="347">Azure portal</a>, create a storage account.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="348"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="348">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="348">Create storage account</strong> dialog box, set the following fields:</p>
<ul sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="350">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="350"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="350">Location</strong> – Select the data center where your environment is located.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="351"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="351">Performance</strong> – We recommend that you select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="351">Standard</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="352"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="352">Account kind</strong> – You must select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="352">StorageV2</strong>.</li>
</ul>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="354"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="354">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="354">Advanced options</strong> dialog box, for the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="354">Data Lake storage Gen2</strong> option, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="354">Enable</strong> under the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="354">Hierarchical namespaces</strong> feature. If you disable this feature, you can't consume data that Finance and Operations apps write by using services such as Power BI data flows.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="355"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="355">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="355">Review and create</strong>. When the deployment is completed, the new resource will be shown in the Azure portal.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="356"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="356">Go to the storage account that you created.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="357"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="357">On the left menu, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="357">Access keys</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="358"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="358">Copy and save the connection string for either <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="358">Key1</strong> or <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="358">Key2</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="359"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="359">Copy and save the storage account name.</p>
</li>
</ol>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="361"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="361">Create a new key vault:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="363">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="363">In the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="363">Azure portal</a>, create a key vault.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="364">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="364">Create key vault</strong> dialog box, in the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="364">Location</strong> field, select the data center where your environment is located.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="365">After key vault is created, select it in the list, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="365">Secrets</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="366">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="366">Generate/Import</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="367">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="367">Create a secret</strong> dialog box, in the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="367">Upload options</strong> field, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="367">Manual</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="368">Enter a name for the secret. Make a note of the name, because you will have to provide it later.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="369">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="369">Value</strong> field, enter the connection string that you obtained from the storage account in the previous procedure.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="370">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="370">Enabled</strong>, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="370">Create</strong>. The secret is created and added to Key Vault.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="371">Go to the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="371">Key Vault Overview</strong>, and make a note of the DNS name.</li>
</ol>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="373"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="373">Create and register an Azure AD application:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="375">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="375"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="375">In the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="375">Azure portal</a>, go to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="375">Azure Active Directory</strong>, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="375">App registrations</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="376"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="376">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="376">New application registration</strong>, and set the following fields:</p>
<ul sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="378">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="378"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="378">Name</strong> – Enter the name of the app.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="379"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="379">Application type</strong> – Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="379">Web API</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="380"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="380">Redirect URI setup</strong> – Enter the URL for your Dynamics 365 instance, such as, <code sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="380">https://yourdynamicsinstance.dynamics.com/auth</code>.</li>
</ul>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="382"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="382">Go to the app that you just created, and copy and save its <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="382">Application (client) ID</strong> value. You will have to provide this value later, when you set up the key vault.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="383"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="383">Go to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="383">API permissions</strong>, and follow these steps:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="385">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="385">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="385">Add a permission</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="386">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="386">Azure Key vault</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="387">After you select delegated permissions, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="387">user_impersonation</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="388">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="388">Add permissions</strong>.</li>
</ol>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="390"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="390">On the menu for the app, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="390">Certificates &amp; secrets</strong>, and then follow these steps to create Key Vault secrets:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="392">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="392">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="392">New client secret</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="393">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="393">Key Description</strong> field, enter a name.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="394">Select a duration, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="394">Add</strong>. A secret is generated in the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="394">Value</strong> field.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="395">Copy and save the secret value.</li>
</ol>
</li>
</ol>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="397"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="397">Create Key Vault secrets:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="399">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="399"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="399">Go to the key vault that you created earlier, and select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="399">Secrets</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="400"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="400">For each secret name in the following table, follow these steps:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="402">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="402">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="402">Generate/Import</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="403">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="403">Create a secret</strong> dialog box, in the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="403">Upload options</strong> field, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="403">Manual</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="404">Create the secret name and value from the following table.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="405">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="405">Enabled</strong>, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="405">Create</strong>. The secret is created and added to Key Vault.</li>
</ol>
<table sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="407">
<thead>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="407">
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="407">Secret name</th>
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="407">Secret value</th>
</tr>
</thead>
<tbody>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="409">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="409">app-id</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="409">The app ID of the application that you created earlier</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="410">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="410">app-secret</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="410">The client secret that you saved earlier</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="411">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="411">storage-account-name</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="411">The name of the storage account that you created earlier, such as <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="411">storageaccount1</strong></td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="412">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="412">storage-account-connection-string</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="412">The connection string that you copied from the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="412">Access keys</strong> page for the storage account</td>
</tr>
</tbody>
</table>
</li>
</ol>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="414"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="414">Authorize the application to access the key vault:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="416">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="416"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="416">In the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="416">Azure portal</a>, open the key vault that you created earlier.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="417"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="417">Select the access policies.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="418"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="418">For each application in the following table, follow these steps:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="420">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="420">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="420">Add Access Policy</strong> to create an access policy.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="421">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="421">Secret permissions</strong> field, select the permissions from the following table.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="422">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="422">Select principal</strong> field, search for the application display name from the following table.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="423">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="423">Select</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="424">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="424">Add</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="425">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="425">Save</strong>.</li>
</ol>
<table sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="427">
<thead>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="427">
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="427">Application</th>
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="427">Permissions</th>
</tr>
</thead>
<tbody>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="429">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="429">The display name of the new application that you created</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="429">Get, List</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="430">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="430"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="430">Microsoft Dynamics ERP Microservices</strong></td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="430">Get, List</td>
</tr>
</tbody>
</table>
</li>
</ol>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="432"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="432">Assign roles to access the storage account:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="434">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="434"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="434">In the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="434">Azure portal</a>, open the storage account that you created earlier.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="435"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="435">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="435">Access Control (IAM)</strong>, and then select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="435">Role Assignments</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="436"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="436">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="436">Add, Add Role Assignment</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="437"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="437">For each application in the following table, follow these steps:</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="439">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="439">Select the role from the following table.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="440">Leave the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="440">Assign access to</strong> field set to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="440">Azure AD user, group, or service principal</strong>.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="441">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="441">Select</strong> field, enter the application from the following table.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="442">Select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="442">Save</strong>.</li>
</ol>
<table sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="444">
<thead>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="444">
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="444">Application</th>
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="444">Role</th>
</tr>
</thead>
<tbody>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="446">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="446">The display name of the new application that you created</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="446">Owner</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="447">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="447">The display name of the new application that you created</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="447">Contributor</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="448">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="448">The display name of the new application that you created</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="448">Storage Account Contributor</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="449">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="449">The display name of the new application that you created</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="449">Storage Blob Data Owner</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="450">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="450"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="450">AI Builder Authorization Service</strong></td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="450">Storage Blob Data Reader</td>
</tr>
</tbody>
</table>
</li>
</ol>
</li>
</ol>
</section>
<section id="tabpanel_CeZOj-G++Q-1_azure-azure-cli" role="tabpanel" data-tab="azure-azure-cli" aria-hidden="true" hidden="hidden">

<pre><code sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="454">function New-FinanceDataLakeAzureResources {
    $defaultSecretExpiryInYear = 1

    $MicrosoftDynamicsERPMicroservicesAppId = '0cdb527f-a8d1-4bf8-9436-b352c68682b2'
    $MicrosoftDynamicsERPMicroservicesCDSAppId = '703e2651-d3fc-48f5-942c-74274233dba8'
    $AIBuilderAuthorizationServiceAppId = 'ad40333e-9910-4b61-b281-e3aeeb8c3ef3'
    $KeyVaultServicePrincipalAppId = 'cfa8b339-82a2-471a-a3c9-0fc0be7a4093'
    $GraphServicePrincipalAppId = '00000003-0000-0000-c000-000000000000'

    Import-Module AzureAD.Standard.Preview
    $connectAzureADParameters = @{ 'Identity' = $true; 'TenantId' = $env:ACC_TID }
    $azContext = AzureAD.Standard.Preview\Connect-AzureAD @connectAzureADParameters
    $userContext = ConvertFrom-Json ((az ad signed-in-user show) -join '')
    $user = Get-AzureADUser -Filter (&quot;UserPrincipalName eq '&quot; + $userContext.UserPrincipalName + &quot;'&quot;)

    $subscriptionId = (Read-Host -Prompt &quot;Enter the Azure Subscription ID: (blank for default)&quot;)
    if ($subscriptionId.Trim() -ne '') {
        $azSubscription = Select-AzSubscription -SubscriptionId $subscriptionId
    }

    $resourceGroupName = (Read-Host -Prompt &quot;Enter the Azure Resource Group name: (blank for 'FinanceDataLake')&quot;)
    if ($null -eq $resourceGroupName -or $resourceGroupName.Trim() -eq '') {
        $resourceGroupName = 'FinanceDataLake'
    }
    $resourceGroup = Get-AzResourceGroup -Name $resourceGroupName -ErrorAction SilentlyContinue

    if (-not ($resourceGroup)) {
        $resourceLocation = ''
        $azResourceLocations = (Get-AzLocation | Select-Object Location).Location
        while ($resourceLocation.Trim() -eq '' -or (-not ($resourceLocation -in $azResourceLocations))) {
            $resourceLocation = (Read-Host -Prompt &quot;Enter the location in which to create the Azure Resource Group: ('help' to see values)&quot;)
            if ($resourceLocation -eq 'help') {
                $azResourceLocations
                $resourceLocation = ''
            }
        }
        $resourceGroup = New-AzResourceGroup -Name $resourceGroupName -Location $resourceLocation
    }
    else {
        $resourceLocation = $resourceGroup.Location
    }

    $clientAppName = (Read-Host -Prompt &quot;Enter the name of the application registration: (blank for 'Finance Data Lake Application')&quot;)
    if ($clientAppName.Trim() -eq '') {
        $clientAppName = 'Finance Data Lake Application'
    }

    Write-Output '================================================================================='

    $service = Get-AzureADServicePrincipal -Filter (&quot;AppId eq '&quot; + $MicrosoftDynamicsERPMicroservicesAppId + &quot;'&quot;)
    if (-not $service) {
        New-AzureADServicePrincipal -AppId $MicrosoftDynamicsERPMicroservicesAppId | Format-Table -AutoSize
        $service = Get-AzureADServicePrincipal -Filter (&quot;AppId eq '&quot; + $MicrosoftDynamicsERPMicroservicesAppId + &quot;'&quot;)
        Write-Output (&quot;Added AAD Enterprise Application 'Microsoft Dynamics ERP Microservices' with Application ID {0}&quot; -f $MicrosoftDynamicsERPMicroservicesAppId)
    }
    else {
        Write-Output (&quot;Found AAD Enterprise Application 'Microsoft Dynamics ERP Microservices' with Application ID {0}&quot; -f $MicrosoftDynamicsERPMicroservicesAppId)
    }
    $MicrosoftDynamicsERPMicroservicesAppObjectId = $service.ObjectId

    $service = Get-AzureADServicePrincipal -Filter (&quot;AppId eq '&quot; + $MicrosoftDynamicsERPMicroservicesCDSAppId + &quot;'&quot;)
    if (-not $service) {
        New-AzureADServicePrincipal -AppId $MicrosoftDynamicsERPMicroservicesCDSAppId | Format-Table -AutoSize
        Write-Output (&quot;Added AAD Enterprise Application 'Microsoft Dynamics ERP Microservices CDS' with Application ID {0}&quot; -f $MicrosoftDynamicsERPMicroservicesCDSAppId)
    }
    else {
        Write-Output (&quot;Found AAD Enterprise Application 'Microsoft Dynamics ERP Microservices CDS' with Application ID {0}&quot; -f $MicrosoftDynamicsERPMicroservicesCDSAppId)
    }

    $service = Get-AzureADServicePrincipal -Filter (&quot;AppId eq '&quot; + $AIBuilderAuthorizationServiceAppId + &quot;'&quot;)
    if (-not $service) {
        New-AzureADServicePrincipal -AppId $AIBuilderAuthorizationServiceAppId | Format-Table -AutoSize
        $service = Get-AzureADServicePrincipal -Filter (&quot;AppId eq '&quot; + $AIBuilderAuthorizationServiceAppId + &quot;'&quot;)
        Write-Output (&quot;Added AAD Enterprise Application 'AI Builder Authorization Service' with Application ID {0}&quot; -f $AIBuilderAuthorizationServiceAppId)
    }
    else {
        Write-Output (&quot;Found AAD Enterprise Application 'AI Builder Authorization Service' with Application ID {0}&quot; -f $AIBuilderAuthorizationServiceAppId)
    }
    $aibuilderAuthorizationServiceObjectId = $service.ObjectId

    Write-Output '================================================================================='

    $clientAppSPN = Get-AzureADServicePrincipal -Filter (&quot;DisplayName eq '&quot; + $clientAppName + &quot;'&quot;)
    if (-not ($clientAppSPN)) {
        $keyVaultPrincipal = Get-AzureADServicePrincipal -Filter (&quot;AppId eq '&quot; + $KeyVaultServicePrincipalAppId + &quot;'&quot;)
        if (-not $keyVaultPrincipal)
        {
            New-AzureADServicePrincipal -AppId $KeyVaultServicePrincipalAppId | Format-Table -AutoSize
            Write-Output &quot;Added Key Vault principal to AAD&quot;
            $keyVaultPrincipal = Get-AzureADServicePrincipal -Filter (&quot;AppId eq '&quot; + $KeyVaultServicePrincipalAppId + &quot;'&quot;)
        }
        $keyVaultAccess = New-Object -TypeName &quot;Microsoft.Open.AzureAD.Model.RequiredResourceAccess&quot;
        $keyVaultAccess.ResourceAppId = $keyVaultPrincipal.AppId
        $keyVaultAccess.ResourceAccess = (New-Object -TypeName &quot;microsoft.open.azuread.model.resourceAccess&quot; -ArgumentList $keyVaultPrincipal.Oauth2Permissions.Id, &quot;Scope&quot;)

        $graphPrincipal = Get-AzureADServicePrincipal -Filter (&quot;AppId eq '&quot; + $GraphServicePrincipalAppId + &quot;'&quot;)
        if (-not $graphPrincipal)
        {
            New-AzureADServicePrincipal -AppId $GraphServicePrincipalAppId | Format-Table -AutoSize
            Write-Output &quot;Added Graph principal to AAD&quot;
            $graphPrincipal = Get-AzureADServicePrincipal -Filter (&quot;AppId eq '&quot; + $GraphServicePrincipalAppId + &quot;'&quot;)
        }
        $userRead = $graphPrincipal.Oauth2Permissions | Where-Object { $_.Type -eq &quot;User&quot; -and $_.Value -eq &quot;User.Read&quot; }
        $graphAccess = New-Object -TypeName &quot;Microsoft.Open.AzureAD.Model.RequiredResourceAccess&quot;
        $graphAccess.ResourceAppId = $graphPrincipal.AppId
        $graphAccess.ResourceAccess = (New-Object -TypeName &quot;microsoft.open.azuread.model.resourceAccess&quot; -ArgumentList $userRead.Id, &quot;Scope&quot;)

        $clientApp = New-AzureADApplication -DisplayName $clientAppName -RequiredResourceAccess @($keyVaultAccess, $graphAccess)
        $clientAppSPN = New-AzureADServicePrincipal -AppId $clientApp.AppId -Tags @($clientAppName)
        $clientAppId = $clientApp.AppId
        Write-Output ('Created App Registration &quot;' + $clientAppName + '&quot; with Application Id: ' + $clientAppId)
    }
    else {
        $clientApp = Get-AzureADApplication -Filter (&quot;DisplayName eq '&quot; + $clientAppName + &quot;'&quot;)
        $clientAppId = $clientApp.AppId
        Write-Output ('Found App Registration &quot;' + $clientAppName + '&quot; with Application Id: ' + $clientAppId)
    }
            
    $clientAppSecretCredential = New-AzureADApplicationPasswordCredential -ObjectId $clientApp.ObjectId -CustomKeyIdentifier &quot;ClientAppAccessKey&quot; -EndDate (get-date).AddYears($defaultSecretExpiryInYear)
    $ClientAppSecret = $clientAppSecretCredential.Value
    $clientAppSpId = $clientAppSPN.ObjectId

    Write-Output ('Generated application secret: ' + $ClientAppSecret)
    Write-Output '================================================================================='

    $templateObject = ConvertFrom-Json $azureTemplate -AsHashtable
    $templateObject.{$schema} = &quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;
    Write-Output 'Provisioning Azure resources. This may take a few minutes.'
    $deployment = New-AzResourceGroupDeployment -ResourceGroupName $resourceGroupName -TemplateObject $templateObject -aibuilderAppObjectId $aibuilderAuthorizationServiceObjectId -clientAppId $clientAppId -clientAppSecret $ClientAppSecret -clientAppSpObjectId  $clientAppSpId -microserviceSpObjectId $MicrosoftDynamicsERPMicroservicesAppObjectId -userSpObjectId $user.ObjectId

    if ($deployment.ProvisioningState -eq 'Succeeded') {
        Write-Output &quot;Successfully deployed the following resources to Azure:&quot;
        Write-Output (&quot;  Key Vault:                         &quot; + $deployment.Outputs.keyVaultName.Value)
        Write-Output (&quot;  Storage Account:                   &quot; + $deployment.Outputs.storageAccountName.Value)
    }
    else {
        Write-Output (&quot;Provisioning Azure resources failed with the following state: &quot; + $deployment.ProvisioningState)
        Write-Output (&quot;Some of the resources may have been created in resource group: &quot; + $resourceGroupName)
    }

    Write-Output '================================================================================='

    $keyVault = Get-AzKeyVault -VaultName $deployment.Outputs.keyVaultName.Value
    Write-Output &quot;Values for LCS Data Lake Add-In:&quot;
    Write-Output (&quot;  Tenant ID:                         &quot; + $subscriptionContext.Context.Subscription.TenantId)
    Write-Output (&quot;  DNS Name:                          &quot; + $keyVault.VaultUri)
    Write-Output &quot;  Storage account secret name:       storage-account-name&quot;
    Write-Output &quot;  Application ID secret name:        app-id&quot;
    Write-Output &quot;  Application Secret secret name:    app-secret&quot;
    Write-Warning &quot;Copy this information for the LCS Add-in as it is not saved. Azure Cloud Shell will eventually time out and close.&quot;

    Write-Output '================================================================================='
    Write-Output &quot;Values for System parameters &gt; Data connections:&quot;
    Write-Output (&quot;  Application ID:                    &quot; + $clientAppId)
    Write-Output (&quot;  Application Secret:                &quot; + $ClientAppSecret)
    Write-Output (&quot;  DNS name:                          &quot; + $keyVault.VaultUri)
    Write-Output &quot;  Secret name:                       storage-account-connection-string&quot;
    Write-Warning &quot;Copy this information for the System parameters as it is not saved. Azure Cloud Shell will eventually time out and close.&quot;
}

$azureTemplate = @&quot;
{
    &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,
    &quot;parameters&quot;: {
      &quot;aibuilderAppObjectId&quot;: {
        &quot;type&quot;: &quot;string&quot;,
        &quot;metadata&quot;: {
          &quot;description&quot;: &quot;Specifies the object ID of the AI Builder application.&quot;
        }
      },
      &quot;clientAppId&quot;: {
        &quot;type&quot;: &quot;string&quot;,
        &quot;metadata&quot;: {
          &quot;description&quot;: &quot;Specifies the application ID of client application.&quot;
        }
      },
      &quot;clientAppSecret&quot;: {
        &quot;type&quot;: &quot;String&quot;,
        &quot;metadata&quot;: {
          &quot;description&quot;: &quot;Specifies the Azure App ID client secret to in azure key vault.&quot;
        }
      },
      &quot;clientAppSpObjectId&quot;: {
        &quot;type&quot;: &quot;string&quot;,
        &quot;metadata&quot;: {
          &quot;description&quot;: &quot;Specifies the object ID of a client application service principal.&quot;
        }
      },
      &quot;userSpObjectId&quot;: {
        &quot;type&quot;: &quot;string&quot;,
        &quot;metadata&quot;: {
          &quot;description&quot;: &quot;Specifies the object ID of tenant admin service principal.&quot;
        }
      },
      &quot;microserviceSpObjectId&quot;: {
        &quot;type&quot;: &quot;string&quot;,
        &quot;metadata&quot;: {
          &quot;description&quot;: &quot;Specifies the object ID of Microsoft Dynamics ERP Microservices service principal.&quot;
        }
      },
      &quot;storageAccountType&quot;: {
        &quot;type&quot;: &quot;string&quot;,
        &quot;defaultValue&quot;: &quot;Standard_LRS&quot;,
        &quot;allowedValues&quot;: [
          &quot;Standard_LRS&quot;,
          &quot;Standard_GRS&quot;,
          &quot;Standard_ZRS&quot;,
          &quot;Premium_LRS&quot;
        ],
        &quot;metadata&quot;: {
          &quot;description&quot;: &quot;Storage Account type&quot;
        }
      }
    },
    &quot;variables&quot;: {
      &quot;storageAccountApiVersion&quot;: &quot;2019-06-01&quot;,
      &quot;keyVaultApiVersion&quot;: &quot;2018-02-14&quot;,
      &quot;secretsPermissions&quot;: [
        &quot;list&quot;,
        &quot;get&quot;
      ],
      &quot;location&quot;: &quot;[resourceGroup().location]&quot;,
      &quot;storageAccountName&quot;: &quot;[concat('store', uniquestring(resourceGroup().id))]&quot;,
      &quot;keyVaultName&quot;: &quot;[concat('keyvault', uniquestring(resourceGroup().id))]&quot;,
      &quot;owner&quot;: &quot;[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]&quot;,
      &quot;contributor&quot;: &quot;[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]&quot;,
      &quot;storageAccountContributor&quot;: &quot;[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]&quot;,
      &quot;storageBlobDataOwner&quot;: &quot;[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]&quot;,
      &quot;storageBlobDataReader&quot;: &quot;[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]&quot;
    },
    &quot;resources&quot;: [
      {
        &quot;type&quot;: &quot;Microsoft.Storage/storageAccounts&quot;,
        &quot;apiVersion&quot;: &quot;[variables('storageAccountApiVersion')]&quot;,
        &quot;name&quot;: &quot;[variables('storageAccountName')]&quot;,
        &quot;location&quot;: &quot;[variables('location')]&quot;,
        &quot;sku&quot;: {
          &quot;name&quot;: &quot;[parameters('storageAccountType')]&quot;
        },
        &quot;kind&quot;: &quot;StorageV2&quot;,
        &quot;properties&quot;: {
          &quot;accessTier&quot;: &quot;Hot&quot;,
          &quot;supportsHttpsTrafficOnly&quot;: true,
          &quot;isHnsEnabled&quot;: true
        },
        &quot;resources&quot;: [
          {
            &quot;type&quot;: &quot;Microsoft.Storage/storageAccounts/providers/roleAssignments&quot;,
            &quot;apiVersion&quot;: &quot;2018-09-01-preview&quot;,
            &quot;name&quot;: &quot;[concat(variables('storageAccountName'), '/Microsoft.Authorization/', guid(uniqueString(variables('storageAccountName'),'1')))]&quot;,
            &quot;dependsOn&quot;: [
              &quot;[variables('storageAccountName')]&quot;
            ],
            &quot;properties&quot;: {
              &quot;roleDefinitionId&quot;: &quot;[variables('owner')]&quot;,
              &quot;principalId&quot;: &quot;[parameters('clientAppSpObjectId')]&quot;
            }
          },
          {
            &quot;type&quot;: &quot;Microsoft.Storage/storageAccounts/providers/roleAssignments&quot;,
            &quot;apiVersion&quot;: &quot;2018-09-01-preview&quot;,
            &quot;name&quot;: &quot;[concat(variables('storageAccountName'), '/Microsoft.Authorization/', guid(uniqueString(variables('storageAccountName'),'2')))]&quot;,
            &quot;dependsOn&quot;: [
              &quot;[variables('storageAccountName')]&quot;
            ],
            &quot;properties&quot;: {
              &quot;roleDefinitionId&quot;: &quot;[variables('contributor')]&quot;,
              &quot;principalId&quot;: &quot;[parameters('clientAppSpObjectId')]&quot;
            }
          },
          {
            &quot;type&quot;: &quot;Microsoft.Storage/storageAccounts/providers/roleAssignments&quot;,
            &quot;apiVersion&quot;: &quot;2018-09-01-preview&quot;,
            &quot;name&quot;: &quot;[concat(variables('storageAccountName'), '/Microsoft.Authorization/', guid(uniqueString(variables('storageAccountName'),'3')))]&quot;,
            &quot;dependsOn&quot;: [
              &quot;[variables('storageAccountName')]&quot;
            ],
            &quot;properties&quot;: {
              &quot;roleDefinitionId&quot;: &quot;[variables('storageAccountContributor')]&quot;,
              &quot;principalId&quot;: &quot;[parameters('clientAppSpObjectId')]&quot;
            }
          },
          {
            &quot;type&quot;: &quot;Microsoft.Storage/storageAccounts/providers/roleAssignments&quot;,
            &quot;apiVersion&quot;: &quot;2018-09-01-preview&quot;,
            &quot;name&quot;: &quot;[concat(variables('storageAccountName'), '/Microsoft.Authorization/', guid(uniqueString(variables('storageAccountName'),'4')))]&quot;,
            &quot;dependsOn&quot;: [
              &quot;[variables('storageAccountName')]&quot;
            ],
            &quot;properties&quot;: {
              &quot;roleDefinitionId&quot;: &quot;[variables('storageBlobDataOwner')]&quot;,
              &quot;principalId&quot;: &quot;[parameters('clientAppSpObjectId')]&quot;
            }
          },
          {
            &quot;type&quot;: &quot;Microsoft.Storage/storageAccounts/providers/roleAssignments&quot;,
            &quot;apiVersion&quot;: &quot;2018-09-01-preview&quot;,
            &quot;name&quot;: &quot;[concat(variables('storageAccountName'), '/Microsoft.Authorization/', guid(uniqueString(variables('storageAccountName'),'5')))]&quot;,
            &quot;dependsOn&quot;: [
              &quot;[variables('storageAccountName')]&quot;
            ],
            &quot;properties&quot;: {
              &quot;roleDefinitionId&quot;: &quot;[variables('storageBlobDataReader')]&quot;,
              &quot;principalId&quot;: &quot;[parameters('aibuilderAppObjectId')]&quot;
            }
          }
        ]
      },
      {
        &quot;type&quot;: &quot;Microsoft.KeyVault/vaults&quot;,
        &quot;apiVersion&quot;: &quot;[variables('keyVaultApiVersion')]&quot;,
        &quot;name&quot;: &quot;[variables('keyVaultName')]&quot;,
        &quot;location&quot;: &quot;[variables('location')]&quot;,
        &quot;dependsOn&quot;: [
          &quot;[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]&quot;
        ],
        &quot;tags&quot;: {
        },
        &quot;properties&quot;: {
          &quot;enabledForDeployment&quot;: false,
          &quot;enabledForTemplateDeployment&quot;: false,
          &quot;enabledForDiskEncryption&quot;: false,
          &quot;enableRbacAuthorization&quot;: false,
          &quot;accessPolicies&quot;: [
            {
              &quot;objectId&quot;: &quot;[parameters('clientAppSpObjectId')]&quot;,
              &quot;tenantId&quot;: &quot;[subscription().tenantId]&quot;,
              &quot;permissions&quot;: {
                &quot;secrets&quot;: &quot;[variables('secretsPermissions')]&quot;
              }
            },
            {
              &quot;objectId&quot;: &quot;[parameters('microserviceSpObjectId')]&quot;,
              &quot;tenantId&quot;: &quot;[subscription().tenantId]&quot;,
              &quot;permissions&quot;: {
                &quot;secrets&quot;: &quot;[variables('secretsPermissions')]&quot;
              }
            },
            {
              &quot;objectId&quot;: &quot;[parameters('userSpObjectId')]&quot;,
              &quot;tenantId&quot;: &quot;[subscription().tenantId]&quot;,
              &quot;permissions&quot;: {
                &quot;secrets&quot;: &quot;[variables('secretsPermissions')]&quot;
              }
            }
          ],
          &quot;tenantId&quot;: &quot;[subscription().tenantId]&quot;,
          &quot;sku&quot;: {
            &quot;name&quot;: &quot;Standard&quot;,
            &quot;family&quot;: &quot;A&quot;
          },
          &quot;enableSoftDelete&quot;: false,
          &quot;networkAcls&quot;: {
            &quot;defaultAction&quot;: &quot;Allow&quot;,
            &quot;bypass&quot;: &quot;AzureServices&quot;
          }
        }
      },
      {
        &quot;type&quot;: &quot;Microsoft.KeyVault/vaults/secrets&quot;,
        &quot;name&quot;: &quot;[concat(variables('keyVaultName'), '/', 'app-id')]&quot;,
        &quot;apiVersion&quot;: &quot;[variables('keyVaultApiVersion')]&quot;,
        &quot;location&quot;: &quot;[variables('location')]&quot;,
        &quot;dependsOn&quot;: [
          &quot;[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]&quot;
        ],
        &quot;properties&quot;: {
          &quot;value&quot;: &quot;[parameters('clientAppId')]&quot;
        }
      },
      {
        &quot;type&quot;: &quot;Microsoft.KeyVault/vaults/secrets&quot;,
        &quot;name&quot;: &quot;[concat(variables('keyVaultName'), '/', 'app-secret')]&quot;,
        &quot;apiVersion&quot;: &quot;[variables('keyVaultApiVersion')]&quot;,
        &quot;location&quot;: &quot;[variables('location')]&quot;,
        &quot;dependsOn&quot;: [
          &quot;[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]&quot;
        ],
        &quot;properties&quot;: {
          &quot;value&quot;: &quot;[parameters('clientAppSecret')]&quot;
        }
      },
      {
        &quot;type&quot;: &quot;Microsoft.KeyVault/vaults/secrets&quot;,
        &quot;name&quot;: &quot;[concat(variables('keyVaultName'), '/', 'storage-account-name')]&quot;,
        &quot;apiVersion&quot;: &quot;[variables('keyVaultApiVersion')]&quot;,
        &quot;location&quot;: &quot;[variables('location')]&quot;,
        &quot;dependsOn&quot;: [
          &quot;[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]&quot;
        ],
        &quot;properties&quot;: {
          &quot;value&quot;: &quot;[variables('storageAccountName')]&quot;
        }
      },
      {
        &quot;type&quot;: &quot;Microsoft.KeyVault/vaults/secrets&quot;,
        &quot;name&quot;: &quot;[concat(variables('keyVaultName'), '/', 'storage-account-connection-string')]&quot;,
        &quot;apiVersion&quot;: &quot;[variables('keyVaultApiVersion')]&quot;,
        &quot;location&quot;: &quot;[variables('location')]&quot;,
        &quot;dependsOn&quot;: [
          &quot;[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]&quot;
        ],
        &quot;properties&quot;: {
          &quot;value&quot;: &quot;[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), variables('storageAccountApiVersion')).keys[0].value, ';EndpointSuffix=core.windows.net')]&quot;
        }
      }
    ],
    &quot;outputs&quot;: {
      &quot;storageAccountName&quot;: {
        &quot;type&quot;: &quot;string&quot;,
        &quot;value&quot;: &quot;[variables('storageAccountName')]&quot;
      },
      &quot;keyVaultName&quot;: {
        &quot;type&quot;: &quot;string&quot;,
        &quot;value&quot;: &quot;[variables('keyVaultName')]&quot;
      }
    }
  }
&quot;@

try {
  New-FinanceDataLakeAzureResources
}
catch {
  Write-Error $_.Exception.Message
  Write-Warning $_.Exception.StackTrace
  $inner = $_.Exception.InnerException
  while ($null -ne $inner) {
    Write-Output 'Inner Exception:'
    Write-Error $_.Exception.Message
    Write-Warning $_.Exception.StackTrace
    $inner = $inner.InnerException
  }
}

</code></pre>
</section>
</div>
<h2 id="configure-the-entity-store" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="893">Configure the entity store</h2>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="895">Follow these steps to set up the entity store in your Finance environment.</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="897">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="897"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="897">Go to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="897">System administration &gt; Setup &gt; System parameters &gt; Data connections</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="898"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="898">Set the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="898">Enable Data Lake integration</strong> option to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="898">Yes</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="899"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="899">Set the following Key Vault fields:</p>
<ul sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="901">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="901"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="901">Application (client) ID</strong> – Enter the application client ID that you created earlier.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="902"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="902">Application Secret</strong> – Enter the secret that you saved for the application that you created earlier.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="903"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="903">DNS name</strong> – You can find the Domain Name System (DNS) name on the application details page for the application that you created earlier.</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="904"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="904">Secret name</strong> – Enter <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="904">storage-account-connection-string</strong>.</li>
</ul>
</li>
</ol>
<h2 id="configure-the-data-lake" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="906">Configure the data lake</h2>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="908">Follow these steps to use LCS to add the Azure Data Lake add-in to the environment.</p>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="910">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="910"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="910">Sign in to LCS, and then, under the environment name on the right side of the page, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="910">Full Details</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="911"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="911">In the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="911">Environment add-ins</strong> section, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="911">Install a new add-in</strong>.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="912"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="912">Select the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="912">Export to Data Lake</strong> add-in.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="913"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="913">Enter the following values.</p>
<table sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="915">
<thead>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="915">
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="915">Value</th>
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="915">Description</th>
</tr>
</thead>
<tbody>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="917">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="917">Tenant ID of the Azure Subscription where the Key Vault is located</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="917">The tenant ID where the storage account, apps, and key vaults are located. To find this value, open the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="917">Azure portal</a>, go to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="917">Azure Active Directory</strong>, and copy the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="917">Tenant ID</strong> value.</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="918">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="918">Provide the DNS name of your Key Vault</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="918">The DNS name of the key vault, such as <code sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="918">https://customkeyvault.vault.azure.net/</code>. (This value matches the DNS name that is used in the entity store.)</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="919">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="919">Provide the secret that contains the name of the storage account</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="919"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="919">storage-account-name</strong></td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="920">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="920">Secret Name for App ID to be used for accessing Data Lake</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="920"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="920">app-id</strong></td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="921">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="921">Secret name to be used with App ID</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="921"><strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="921">app-secret</strong></td>
</tr>
</tbody>
</table>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="923"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="923">Agree to the terms, and select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="923">Install</strong>.</p>
</li>
</ol>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="925">The add-in will be installed within a few minutes.</p>
<h2 id="configure-ai-builder" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="927">Configure AI Builder</h2>
<ol sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="929">
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="929"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="929">Sign in to LCS, and open the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="929">Environment details</strong> page.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="930"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="930">Scroll to the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="930">Environment add-ins</strong> section. You should see the add-ins that are already installed in this environment. If the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="930">Export to Data Lake</strong> add-in isn't among them, configure this add-in.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="931"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="931">Select the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="931">Get insights</strong> add-in.</p>
</li>
<li sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="932"><p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="932">On the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="932">Get insights</strong> add-in details page, enter the following values.</p>
<table sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="934">
<thead>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="934">
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="934">Value</th>
<th sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="934">Description</th>
</tr>
</thead>
<tbody>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="936">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="936">CDS Organization URL</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="936">The Dataverse organization URL of the Dataverse instance. To find this value, open the <a href="https://make.powerapps.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="936">Power Apps portal</a>, select the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="936">Settings</strong> button (gear symbol) in the upper-right upper corner, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="936">Advanced settings</strong>, and copy the URL. (The URL ends with &quot;dynamics.com.&quot;)</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="937">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="937">CDS Org ID</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="937">The environment ID of the Dataverse instance. To find this value, open the <a href="https://make.powerapps.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="937">Power Apps portal</a>, select the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="937">Settings</strong> button (gear symbol) in the upper-right upper corner, select <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="937">Customizations &gt; Developer resources &gt; Instance Reference Information</strong>, and copy the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="937">ID</strong> value.</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="938">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="938">CDS Tenant ID (Directory ID from AAD)</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="938">The tenant ID of the Dataverse instance. To find this value, open the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="938">Azure portal</a>, go to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="938">Azure Active Directory</strong>, and copy the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="938">Tenant ID</strong> value.</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="939">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="939">Provide user object ID who has system administrator role</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="939">The Azure AD user object ID of the user in Dataverse. This user must be a system administrator of the Dataverse instance. To find this value, open the <a href="https://portal.azure.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="939">Azure portal</a>, go to <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="939">Azure Active Directory &gt; Users</strong>, select the user, and then, in the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="939">Identity</strong> section, copy the <strong sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="939">Object ID</strong> value.</td>
</tr>
<tr sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="940">
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="940">Is this the default CDS environment for the tenant?</td>
<td sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="940">If the Dataverse instance was the first production instance that was created, select this check box. If the Dataverse instance was manually created, clear this check box.</td>
</tr>
</tbody>
</table>
</li>
</ol>
<h2 id="feedback-and-support" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="942">Feedback and support</h2>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="944">Please send an email to <a href="mailto:fiap@microsoft.com" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="944">Customer payment insights (Preview)</a> if you are interested in providing feedback or need support.</p>
<h2 id="privacy-notice" sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="946">Privacy notice</h2>
<p sourcefile="articles/finance/finance-insights/configure-for-fin-insites.md" sourcestartlinenumber="948">Previews (1) might use less privacy and fewer security measures than the Dynamics 365 Finance and Operations service, (2) aren't included in the service level agreement (SLA) for this service, (3) should not be used to process personal data or other data that is subject to legal or regulatory compliance requirements, and (4) have limited support.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>

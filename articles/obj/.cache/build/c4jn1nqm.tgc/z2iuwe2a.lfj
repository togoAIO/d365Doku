<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Prorate header charges to matching sales lines </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Prorate header charges to matching sales lines ">
    <meta name="generator" content="docfx 2.56.6.0">
    <meta name="description" content="This topic describes additional capabilities for calculating and applying auto-charges to Commerce channel orders by using the advanced auto-charges feature.">
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="">
    <meta property="docfx:tocrel" content="TOC.html">
    <meta name="searchOption" content="noindex">
    
    
    <meta name="robots" content="NOINDEX, NOFOLLOW">
    
    <meta name="ms.search.scope" content="Core, Operations, Retail, Commerce, ShowInHelp">
    <meta name="ms.search.region" content="global">
    <meta name="ms.search.industry" content="Retail">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="row">
          <div class="col-sm-12">
            
<div class="sidenav hide-when-search"> 
  <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
  <div class="sidetoggle collapse" id="sidetoggle">
    <div id="sidetoc"></div>
  </div>
</div>
            <div class="row toc-offset">
              
              <div class="col-sm-12 col-md-9">
                <article class="article" id="_content" data-uid="">
<h1 id="prorate-header-charges-to-matching-sales-lines">Prorate header charges to matching sales lines</h1>


<p>This topic describes the functionality for grouping header-level auto-charges and prorating them to commerce sales lines. This functionality is available for transactions that are created at the point of sale (POS) in Retail version 10.0.1 and sales that are created in a call center in Retail version 10.0.2.</p>
<p>This functionality is available only if the <a href="https://docs.microsoft.com/dynamics365/unified-operations/retail/omni-auto-charges">advanced auto-charges</a> feature is turned on by using the option on the <strong>Commerce parameters</strong> page. Additionally, the enhanced calculation method for auto-charges can be applied only to sales orders that are created through commerce channels (the POS, a call center, and the Dynamics e-Commerce platform).</p>
<p>This new functionality gives organizations more flexibility in the way that header-level auto-charges are calculated and applied to sales transactions.</p>
<p>In versions of the app earlier than version 10.0.1, header-level auto-charges that have a specific mode of delivery relation are calculated only when there is a match with the mode of delivery that is defined on the sales order header.</p>
<p>For example, header-level auto-charges are defined for mode of delivery <strong>99</strong> and mode of delivery <strong>11</strong>. A sales order is created, and mode of delivery <strong>99</strong> is defined on the order header. However, some of the sale lines are set up so that they're shipped by using mode of delivery <strong>11</strong>. In this case, only the header-level charges that are linked to mode of delivery <strong>99</strong> are considered and applied to the sales order.</p>
<p>In Commerce, the header-level charges have an additional feature that lets you define a <a href="https://docs.microsoft.com/dynamics365/unified-operations/retail/configure-call-center-delivery">tiered charge configuration</a> that is based on the order value. For example, if the order value is between $50.00 and $200.00, an organization might want to charge a freight charge of $5.00. However, if the order value is between $200.01 and $500.00, the freight charge might be $4.00.</p>
<p>Some organizations want the benefits of the tiered charge calculation that is provided with header-level charges. However, in scenarios that involve mixed modes of delivery, they also want to make sure that the charges that are calculated are based on a match with the mode of delivery that is defined on each sales line.</p>
<p>You can now configure header-level auto-charges so that all modes of delivery on the order are considered when charges are calculated. This functionality requires a more complex calculation logic to calculate the header-level charges. The logic groups together all the items that are shipped using the same mode of delivery, and it treats that group as the calculation group for the items when it calculates the header-level auto-charges. For items that have the same mode of delivery, auto-charges are calculated based on the combined sales value of the items. In this way, the appropriate auto-charge tier is determined.</p>
<p>After the appropriate header-level charges are obtained for the sales lines that are shipped using the same mode of delivery, the calculated charges are prorated down to the sales line level. Because these charges are at the line level and not kept at the header level, a more specific link is made between the item and the charge value that calculated for it. This behavior can be useful in partial return scenarios, where an organization wants to refund only part of the charge instead of the whole charge when only some items are returned.</p>
<h2 id="scenarios">Scenarios</h2>
<p>The following two sample scenarios outline how these charges are calculated both when the new functionality is used and when it isn't used.</p>
<h3 id="scenario-1">Scenario 1</h3>
<p>This scenario outlines the behavior when the <strong>Pro-rate to matching sales lines</strong> option is set to <strong>No</strong> in the auto-charge setup. (The behavior is equivalent to the behavior of header-level charges in app versions that are earlier than version 10.0.1.)</p>
<p>In this scenario, the organization has defined header-level charges for mode of delivery relation <strong>99</strong> and mode of delivery relation <strong>11</strong>. No auto-charges are configured for mode of delivery <strong>21</strong>.</p>
<p><img src="media/99_disabled.png" alt="Auto-charges for mode of delivery 99 when matching line proration is turned off"></p>
<p><img src="media/11_disabled.png" alt="Auto-charges for mode of delivery 11 when matching line proration is turned off"></p>
<p>A sales order is created in the call center, and the mode of delivery is set to <strong>99</strong>. This order contains five items. Two order lines have been configured to use mode of delivery <strong>99</strong>, two lines have been configured to use mode of delivery <strong>11</strong>, and one line has been configured to use mode of delivery <strong>21</strong>, as shown in the following table.</p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Line quantity</th>
<th>Delivery mode</th>
<th>Price per unit</th>
</tr>
</thead>
<tbody>
<tr>
<td>81331</td>
<td>1</td>
<td>11</td>
<td>$10</td>
</tr>
<tr>
<td>81332</td>
<td>1</td>
<td>99</td>
<td>$50</td>
</tr>
<tr>
<td>81333</td>
<td>2</td>
<td>11</td>
<td>$30</td>
</tr>
<tr>
<td>81334</td>
<td>3</td>
<td>99</td>
<td>$10</td>
</tr>
<tr>
<td>81334</td>
<td>3</td>
<td>21</td>
<td>$5</td>
</tr>
</tbody>
</table>
<p>In this scenario, the whole order is evaluated against the auto-charge table for mode of delivery <strong>99</strong>. The full total of all sales lines is used to determine a matching tier in the auto-charge configuration, and this charge is applied at the order header level. In this example, the order total is $165.00, and the $15.00 freight charge is applied to the order header. Auto-charges that are configured for mode of delivery <strong>11</strong> are never referenced or applied.</p>
<p>In this scenario, if a customer returns some of the items on the order, and if the <a href="https://docs.microsoft.com/dynamics365/unified-operations/retail/omni-auto-charges#setup-and-configuration-2">charge code has been configured so that it will be refunded</a>, the total header-level charge is systematically applied to the refund, even if only some of the items are returned.</p>
<h3 id="scenario-2">Scenario 2</h3>
<p>In this scenario, header-level charges are defined for mode of delivery relation <strong>99</strong> and mode of delivery relation <strong>11</strong>. However, the <strong>Pro-rate to matching sales lines</strong> option is set to <strong>Yes</strong> for these auto-charge tables.</p>
<p><img src="media/99_enabled.png" alt="Auto-charges for mode of delivery 99 when matching line proration is turned on"></p>
<p><img src="media/11_enabled.png" alt="Auto-charges for mode of delivery 11 when matching line proration is turned on"></p>
<p>This scenario uses the same sales order that contains five lines. The mode of delivery on the order header is set to <strong>99</strong>, but the mode of delivery for each item on the sales order is configured as shown in the following table.</p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Line quantity</th>
<th>Delivery mode</th>
<th>Price per unit</th>
</tr>
</thead>
<tbody>
<tr>
<td>81331</td>
<td>1</td>
<td>11</td>
<td>$10</td>
</tr>
<tr>
<td>81332</td>
<td>1</td>
<td>99</td>
<td>$50</td>
</tr>
<tr>
<td>81333</td>
<td>2</td>
<td>11</td>
<td>$30</td>
</tr>
<tr>
<td>81334</td>
<td>3</td>
<td>99</td>
<td>$10</td>
</tr>
<tr>
<td>81334</td>
<td>3</td>
<td>21</td>
<td>$5</td>
</tr>
</tbody>
</table>
<p>Because the auto-charge configuration is set to prorate to matching sales lines, the system performs the following calculation steps.</p>
<ol>
<li><p>All items that have the same mode of delivery are grouped together, and the system calculates the total product value of the items in the group.</p>
<p><strong>Delivery mode 11</strong></p>
<ul>
<li>Item 81331, quantity 1 = $10</li>
<li>Item 81333, quantity 2 = $60 net ($30 per unit)</li>
<li><strong>Total product value for delivery mode 11 = $70</strong></li>
</ul>
<p><strong>Delivery mode 99</strong></p>
<ul>
<li>Item 81332, quantity 1 = $50</li>
<li>Item 81334, quantity 3 = $30 net</li>
<li><strong>Total product value for delivery mode 99 = $80</strong></li>
</ul>
<p><strong>Delivery mode 21</strong></p>
<ul>
<li>Item 81334, quantity 3 = $15 net</li>
<li><strong>Total product value for delivery mode 21 = $15</strong></li>
</ul>
</li>
<li><p>The system looks for the configuration for header-level auto-charges that matches the customer and mode of delivery settings for each group of items. If the configuration is found, the system looks in the tiered configuration to find the charge that should be applied, based on the total product value of items in the mode of delivery group.</p>
<p><strong>Delivery mode 11</strong></p>
<ul>
<li>Total product value = $70</li>
<li><strong>Charge value = $7</strong></li>
</ul>
<p><strong>Delivery mode 99</strong></p>
<ul>
<li>Total product value = $80</li>
<li><strong>Charge value = $15</strong></li>
</ul>
<p><strong>Delivery mode 21</strong></p>
<ul>
<li>Total product value = $15</li>
<li><strong>Charge value = $0</strong> (No auto-charges have been configured for this combination of a customer and a mode of delivery.)</li>
</ul>
<p><img src="media/step2mode11.png" alt="Delivery mode 11 charges fall into the highlighted tier"></p>
<p><img src="media/step2mode99.png" alt="Delivery mode 99 charges fall into the highlighted tier"></p>
</li>
<li><p>The system calculates the charge value that should be applied to each line, based on proration logic that considers the proportional value of the line in relation to the group's total product value.</p>
<p><strong>Delivery mode 11</strong></p>
<ul>
<li>Charge value = $7</li>
<li>Group product value = $70</li>
<li>Line 1 value = $10 (= 14.2857 percent of the group value)</li>
<li>Line 3 value = $60 (= 85.7143 percent of the group value)</li>
<li><strong>Line charge for line 1 = $1</strong></li>
<li><strong>Line charge for line 3 = $6</strong></li>
</ul>
<p><strong>Delivery mode 99</strong></p>
<ul>
<li>Charge value = $15</li>
<li>Group product value = $80</li>
<li>Line 2 value = $50 (= 62.5 percent of the group value)</li>
<li>Line 4 value = $30 (= 37.5 percent of the group value)</li>
<li><strong>Line charge for line 2 = $9.38</strong></li>
<li><strong>Line charge for line 4 = $5.62</strong></li>
</ul>
<p><strong>Delivery mode 21</strong></p>
<ul>
<li>Charge value = $0</li>
<li>Group product value = $15</li>
<li>Line 5 value = $15 (= 100 percent of the group value)</li>
<li><strong>Line charge for line 5 = $0</strong></li>
</ul>
</li>
</ol>
<p>Therefore, for this example, item 81334 will be assigned a freight charge of $5.62. You can view these charges on the <strong>Maintain charges</strong> page for the sales line. The following illustration shows what this page looks like for item 81334.</p>
<p><img src="media/proratedlinecharge.png" alt="Prorated charges on sales line for item 81334"></p>
<p>When this method of calculation is used in a partial return scenario, if the charge code is refundable, only the part of the charge that is allocated to that line will be refunded when the item is returned.</p>
<h2 id="additional-resources">Additional resources</h2>
<p><a href="omni-auto-charges.html">Omni-channel advanced auto charges</a></p>
<p><a href="auto-charges-by-channel.html">Enable and configure auto charges by channel</a></p>
</article>
              </div>
              
<div class="hidden-sm col-md-3" role="complementary">
  <div class="sideaffix">
    <div class="contribution">
      <ul class="nav">
        <li>
          <a href="https://github.com/MicrosoftDocs/Dynamics-365-unified-Operations-public/blob/live/articles/commerce/pro-rate-charges-matching-lines.md/#L1" class="contribution-link">Improve this Doc</a>
        </li>
      </ul>
    </div>
    <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
    <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
    </nav>
  </div>
</div>

            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Copyright � 2015-2017 Microsoft<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
